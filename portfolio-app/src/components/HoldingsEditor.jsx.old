import React, { useState } from 'react'
import { api } from '../api'
import AddHoldingForm from './AddHoldingForm'
import EditHoldingForm from './EditHoldingForm'
import Modal from './Modal'

export default function HoldingsEditor({ divId, subdivId, holdings = [], onUpdate, subdivisionName = '' }) {
  const [hoveredRow, setHoveredRow] = useState(null)
  const [showAddForm, setShowAddForm] = useState(false)
    const [editingHolding, setEditingHolding] = useState(null)
  const [adjustHolding, setAdjustHolding] = useState(null)
  const [adjustAmount, setAdjustAmount] = useState('')
  const [adjustMode, setAdjustMode] = useState('add')
  const [loading, setLoading] = useState(false)
  const [successMessage, setSuccessMessage] = useState('')

  const updateHolding = async (hid, data) => {
    try {
      await api.updateHolding(hid, data)
      setSuccessMessage('‚úÖ Changes saved!')
      setTimeout(() => setSuccessMessage(''), 2000)
      onUpdate?.()
    } catch (e) {
      console.error('Failed to update holding:', e)
      alert('Failed to save changes: ' + e.message)
    }
  }

  async function deleteHolding(hid) {
    if (confirm('Delete holding?')) {
      await api.deleteHolding(hid)
      onUpdate?.()
    }
  }

  async function addNew(data) {
    if (!divId) {
      alert('Error: Division ID is required to add holdings')
      return
    }
    setLoading(true)
    try {
      const payload = subdivId ? { ...data, subdivisionId: subdivId } : data
      await api.addHolding(divId, payload)
      setShowAddForm(false)
      setSuccessMessage('‚úÖ Holding added successfully!')
      setTimeout(() => setSuccessMessage(''), 3000)
      onUpdate?.()
    } catch (e) {
      alert('Failed to add holding: ' + e.message)
    } finally {
      setLoading(false)
    }
  }

  function openAdjustModal(h) {
    setAdjustHolding(h)
    setAdjustAmount('')
    setAdjustMode('add')
  }

  function closeAdjustModal() {
    setAdjustHolding(null)
    setAdjustAmount('')
    setAdjustMode('add')
  }

  async function applyAdjust() {
    if (!adjustHolding) return
    const amt = Number(adjustAmount)
    if (!amt || amt < 0) return
    const delta = adjustMode === 'add' ? amt : -amt
    const live = holdings.find(h => h.id === adjustHolding.id) || adjustHolding
    const invested = Math.max(0, (Number(live.invested) || 0) + delta)
    const current = Math.max(0, (Number(live.current) || 0) + delta)
    await updateHolding(adjustHolding.id, { invested, current })
    closeAdjustModal()
  }

  return (
    <div style={{ marginTop: 8, overflowX: 'auto', position: 'relative' }}>
      {successMessage && (
        <div style={{
          position: 'fixed',
          top: 20,
          right: 20,
          background: 'linear-gradient(135deg, #22c55e, #16a34a)',
          color: 'white',
          padding: '12px 20px',
          borderRadius: 8,
          boxShadow: '0 4px 20px rgba(34, 197, 94, 0.4)',
          zIndex: 1000,
          fontWeight: 600,
          fontSize: 14,
          animation: 'slideIn 0.3s ease-out'
        }}>
          {successMessage}
        </div>
      )}
      <table style={{ width: '100%', fontSize: 'clamp(10px, 1.5vw, 12px)', borderCollapse: 'collapse', minWidth: 700 }}>
        <thead>
          <tr style={{ borderBottom: '2px solid #2d3f5f' }}>
            <th style={{ textAlign: 'left', padding: '10px 8px', color: '#7c92ab', fontSize: 'clamp(9px, 1.3vw, 10px)', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Holding</th>
            <th style={{ textAlign: 'right', padding: '10px 8px', color: '#7c92ab', width: 'clamp(120px, 15vw, 180px)', fontSize: 'clamp(9px, 1.3vw, 10px)', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Invested</th>
            <th style={{ textAlign: 'right', padding: '10px 8px', color: '#7c92ab', width: 'clamp(120px, 15vw, 180px)', fontSize: 'clamp(9px, 1.3vw, 10px)', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Current</th>
            <th style={{ textAlign: 'right', padding: '10px 8px', color: '#7c92ab', width: 80, fontSize: 'clamp(9px, 1.3vw, 10px)', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.5px' }}>P/L</th>
            <th style={{ textAlign: 'right', padding: '10px 8px', color: '#7c92ab', width: 100, fontSize: 'clamp(9px, 1.3vw, 10px)', fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Target %</th>
            <th style={{ textAlign: 'center', padding: '10px 8px', width: 60 }}></th>
          </tr>
        </thead>
        <tbody>
          {holdings.map(h => {
            const pl = (Number(h.current) || 0) - (Number(h.invested) || 0)
            return (
              <tr 
                key={h.id} 
                style={{ borderBottom: '1px solid #1a2436', background: hoveredRow === h.id ? 'rgba(99, 102, 241, 0.05)' : 'transparent', transition: 'background 0.15s ease' }}
                onMouseEnter={() => setHoveredRow(h.id)}
                onMouseLeave={() => setHoveredRow(null)}
              >
                <td style={{ padding: '8px', color: '#e6e9ef', position: 'relative' }}>
                  <input
                    value={editingValues[h.id]?.name ?? h.name}
                    onChange={e => debouncedUpdate(h.id, 'name', e.target.value)}
                    onBlur={() => {
                      // Save immediately on blur if there's a pending change
                      const timer = debounceTimers.current[`${h.id}-name`]
                      if (timer) {
                        clearTimeout(timer)
                        const currentValue = editingValues[h.id]?.name
                        if (currentValue !== undefined && currentValue !== h.name) {
                          updateHolding(h.id, { name: currentValue })
                        }
                      }
                    }}
                    style={{ 
                      width: '100%', 
                      padding: '8px 10px', 
                      background: savingIds.has(h.id) ? '#1a2436' : '#0f1724', 
                      color: '#e6e9ef', 
                      border: `2px solid ${savingIds.has(h.id) ? '#0ea5e9' : hoveredRow === h.id ? '#4f5d73' : '#2d3f5f'}`, 
                      borderRadius: 6, 
                      fontSize: 13, 
                      fontWeight: 500,
                      transition: 'all 0.2s ease',
                      outline: 'none'
                    }}
                    placeholder="Holding name"
                  />
                  {savingIds.has(h.id) && (
                    <span style={{ 
                      position: 'absolute', 
                      right: 16, 
                      top: '50%', 
                      transform: 'translateY(-50%)',
                      color: '#0ea5e9',
                      fontSize: 10,
                      fontWeight: 700
                    }}>üíæ Saving...</span>
                  )}
                </td>
                <td style={{ padding: '6px', textAlign: 'right' }}>
                  <div style={{ display: 'flex', gap: 4, alignItems: 'center', justifyContent: 'flex-end' }}>
                    <button
                      type="button"
                      onClick={() => {
                        const newInvested = Math.max(0, Number(h.invested) - 1000)
                        const newCurrent = Math.max(0, Number(h.current) - 1000)
                        updateHolding(h.id, { invested: newInvested, current: newCurrent })
                      }}
                      style={{ 
                        background: 'linear-gradient(135deg, #4b5563, #374151)', 
                        color: '#e6e9ef', 
                        border: 'none', 
                        borderRadius: 5, 
                        padding: '6px 9px', 
                        fontSize: 12, 
                        fontWeight: 700,
                        cursor: 'pointer', 
                        transition: 'all 0.2s',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                      }}
                      onMouseEnter={e => { e.target.style.transform = 'scale(1.05)'; e.target.style.boxShadow = '0 3px 8px rgba(0,0,0,0.3)' }}
                      onMouseLeave={e => { e.target.style.transform = 'scale(1)'; e.target.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)' }}
                      title="Decrease by ‚Çπ1000"
                    >‚àí</button>
                    <input
                      type="number"
                      value={editingValues[h.id]?.invested ?? h.invested}
                      onChange={e => debouncedUpdate(h.id, 'invested', Number(e.target.value) || 0)}
                      onBlur={() => {
                        const timer = debounceTimers.current[`${h.id}-invested`]
                        if (timer) {
                          clearTimeout(timer)
                          const currentValue = editingValues[h.id]?.invested
                          if (currentValue !== undefined && currentValue !== h.invested) {
                            updateHolding(h.id, { invested: currentValue })
                          }
                        }
                      }}
                      style={{ 
                        width: 90, 
                        padding: '6px 8px', 
                        background: '#0f1724', 
                        color: '#e6e9ef', 
                        border: `2px solid ${savingIds.has(h.id) ? '#0ea5e9' : '#2d3f5f'}`, 
                        borderRadius: 5, 
                        textAlign: 'right', 
                        fontSize: 12, 
                        fontWeight: 600,
                        transition: 'all 0.2s ease',
                        outline: 'none'
                      }}
                    />
                    <button
                      type="button"
                      onClick={() => {
                        const newInvested = Number(h.invested) + 1000
                        const newCurrent = Number(h.current) + 1000
                        updateHolding(h.id, { invested: newInvested, current: newCurrent })
                      }}
                      style={{ 
                        background: 'linear-gradient(135deg, #22c55e, #16a34a)', 
                        color: '#ffffff', 
                        border: 'none', 
                        borderRadius: 5, 
                        padding: '6px 9px', 
                        fontSize: 12, 
                        fontWeight: 700,
                        cursor: 'pointer', 
                        transition: 'all 0.2s',
                        boxShadow: '0 2px 4px rgba(34, 197, 94, 0.3)'
                      }}
                      onMouseEnter={e => { e.target.style.transform = 'scale(1.05)'; e.target.style.boxShadow = '0 3px 8px rgba(34, 197, 94, 0.5)' }}
                      onMouseLeave={e => { e.target.style.transform = 'scale(1)'; e.target.style.boxShadow = '0 2px 4px rgba(34, 197, 94, 0.3)' }}
                      title="Increase by ‚Çπ1000"
                    >+</button>
                    <button
                      type="button"
                      onClick={() => openAdjustModal(h)}
                      style={{ 
                        background: 'linear-gradient(135deg, #0ea5e9, #0284c7)', 
                        color: '#ffffff', 
                        border: 'none', 
                        borderRadius: 5, 
                        padding: '6px 10px', 
                        fontSize: 11, 
                        cursor: 'pointer', 
                        transition: 'all 0.2s', 
                        fontWeight: 700,
                        boxShadow: '0 2px 4px rgba(14, 165, 233, 0.3)'
                      }}
                      onMouseEnter={e => { e.target.style.transform = 'scale(1.05)'; e.target.style.boxShadow = '0 3px 8px rgba(14, 165, 233, 0.5)' }}
                      onMouseLeave={e => { e.target.style.transform = 'scale(1)'; e.target.style.boxShadow = '0 2px 4px rgba(14, 165, 233, 0.3)' }}
                      title="Custom adjust (applies to invested & current)"
                    >‚ö° Custom</button>
                  </div>
                </td>
                <td style={{ padding: '6px', textAlign: 'right' }}>
                  <div style={{ display: 'flex', gap: 4, alignItems: 'center', justifyContent: 'flex-end' }}>
                    <button
                      type="button"
                      onClick={() => updateHolding(h.id, { current: Math.max(0, Number(h.current) - 1000) })}
                      style={{ 
                        background: 'linear-gradient(135deg, #4b5563, #374151)', 
                        color: '#e6e9ef', 
                        border: 'none', 
                        borderRadius: 5, 
                        padding: '6px 9px', 
                        fontSize: 12, 
                        fontWeight: 700,
                        cursor: 'pointer', 
                        transition: 'all 0.2s',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                      }}
                      onMouseEnter={e => { e.target.style.transform = 'scale(1.05)'; e.target.style.boxShadow = '0 3px 8px rgba(0,0,0,0.3)' }}
                      onMouseLeave={e => { e.target.style.transform = 'scale(1)'; e.target.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)' }}
                      title="Decrease by ‚Çπ1000"
                    >‚àí</button>
                    <input
                      type="number"
                      value={editingValues[h.id]?.current ?? h.current}
                      onChange={e => debouncedUpdate(h.id, 'current', Number(e.target.value) || 0)}
                      onBlur={() => {
                        const timer = debounceTimers.current[`${h.id}-current`]
                        if (timer) {
                          clearTimeout(timer)
                          const currentValue = editingValues[h.id]?.current
                          if (currentValue !== undefined && currentValue !== h.current) {
                            updateHolding(h.id, { current: currentValue })
                          }
                        }
                      }}
                      style={{ 
                        width: 90, 
                        padding: '6px 8px', 
                        background: '#0f1724', 
                        color: '#e6e9ef', 
                        border: `2px solid ${savingIds.has(h.id) ? '#0ea5e9' : '#2d3f5f'}`, 
                        borderRadius: 5, 
                        textAlign: 'right', 
                        fontSize: 12, 
                        fontWeight: 600,
                        transition: 'all 0.2s ease',
                        outline: 'none'
                      }}
                    />
                    <button
                      type="button"
                      onClick={() => updateHolding(h.id, { current: Number(h.current) + 1000 })}
                      style={{ 
                        background: 'linear-gradient(135deg, #22c55e, #16a34a)', 
                        color: '#ffffff', 
                        border: 'none', 
                        borderRadius: 5, 
                        padding: '6px 9px', 
                        fontSize: 12, 
                        fontWeight: 700,
                        cursor: 'pointer', 
                        transition: 'all 0.2s',
                        boxShadow: '0 2px 4px rgba(34, 197, 94, 0.3)'
                      }}
                      onMouseEnter={e => { e.target.style.transform = 'scale(1.05)'; e.target.style.boxShadow = '0 3px 8px rgba(34, 197, 94, 0.5)' }}
                      onMouseLeave={e => { e.target.style.transform = 'scale(1)'; e.target.style.boxShadow = '0 2px 4px rgba(34, 197, 94, 0.3)' }}
                      title="Increase by ‚Çπ1000"
                    >+</button>
                  </div>
                </td>
                <td style={{ padding: '8px', textAlign: 'right', color: pl >= 0 ? '#22c55e' : '#ef4444', fontWeight: 600 }}>
                  {pl >= 0 ? '+' : ''}‚Çπ{pl.toLocaleString()}
                </td>
                <td style={{ padding: '8px', textAlign: 'right' }}>
                  <input
                    type="number"
                    step="0.01"
                    value={editingValues[h.id]?.targetPercent ?? h.targetPercent ?? ''}
                    onChange={e => debouncedUpdate(h.id, 'targetPercent', Number(e.target.value) || 0)}
                    onBlur={() => {
                      const timer = debounceTimers.current[`${h.id}-targetPercent`]
                      if (timer) {
                        clearTimeout(timer)
                        const currentValue = editingValues[h.id]?.targetPercent
                        if (currentValue !== undefined && currentValue !== h.targetPercent) {
                          updateHolding(h.id, { targetPercent: currentValue })
                        }
                      }
                    }}
                    style={{ 
                      width: '100%', 
                      padding: '7px 10px', 
                      background: '#0f1724', 
                      color: '#e6e9ef', 
                      border: `2px solid ${savingIds.has(h.id) ? '#0ea5e9' : '#2d3f5f'}`, 
                      borderRadius: 5, 
                      textAlign: 'right', 
                      fontSize: 12, 
                      fontWeight: 600,
                      transition: 'all 0.2s ease',
                      outline: 'none'
                    }}
                    placeholder="0.00"
                  />
                </td>
                <td style={{ padding: '8px', textAlign: 'center' }}>
                  {hoveredRow === h.id && (
                    <button
                      type="button"
                      onClick={() => deleteHolding(h.id)}
                      style={{ background: '#ef4444', color: 'white', border: 'none', padding: '4px 10px', borderRadius: 4, cursor: 'pointer', fontSize: 10, fontWeight: 600, transition: 'all 0.2s ease' }}
                      onMouseEnter={(e) => e.target.style.background = '#dc2626'}
                      onMouseLeave={(e) => e.target.style.background = '#ef4444'}
                    >
                      Delete
                    </button>
                  )}
                </td>
              </tr>
            )
          })}
          {/* Add new button */}
          <tr style={{ borderTop: '2px solid #2d3f5f', background: '#0f1724' }}>
            <td colSpan="6" style={{ padding: '12px', textAlign: 'center' }}>
              <button
                onClick={() => setShowAddForm(true)}
                disabled={loading}
                style={{
                  background: loading ? '#6b7280' : '#22c55e',
                  color: 'white',
                  border: 'none',
                  borderRadius: 6,
                  padding: '8px 16px',
                  fontSize: 12,
                  fontWeight: 700,
                  cursor: loading ? 'not-allowed' : 'pointer',
                  transition: 'all 0.2s ease',
                  opacity: loading ? 0.6 : 1,
                }}
                onMouseEnter={(e) => !loading && (e.target.style.background = '#16a34a')}
                onMouseLeave={(e) => !loading && (e.target.style.background = '#22c55e')}
              >
                {loading ? '‚è≥ Adding...' : '‚ûï Add Holding'}
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <AddHoldingForm
        isOpen={showAddForm}
        onClose={() => setShowAddForm(false)}
        onAdd={addNew}
        subdivisionName={subdivisionName}
      />

      <Modal
        isOpen={!!adjustHolding}
        onClose={closeAdjustModal}
        title={`Adjust ${adjustHolding?.name || 'holding'}`}
      >
        <div style={{ display: 'flex', gap: 10, marginBottom: 16 }}>
          <button
            onClick={() => setAdjustMode('add')}
            style={{
              flex: 1,
              padding: '10px 12px',
              borderRadius: 8,
              border: '1px solid #1e293b',
              background: adjustMode === 'add' ? '#22c55e' : '#0f172a',
              color: adjustMode === 'add' ? '#0b1910' : '#e6e9ef',
              fontWeight: 700,
              cursor: 'pointer',
            }}
          >
            Add
          </button>
          <button
            onClick={() => setAdjustMode('deduct')}
            style={{
              flex: 1,
              padding: '10px 12px',
              borderRadius: 8,
              border: '1px solid #1e293b',
              background: adjustMode === 'deduct' ? '#ef4444' : '#0f172a',
              color: adjustMode === 'deduct' ? '#fff1f2' : '#e6e9ef',
              fontWeight: 700,
              cursor: 'pointer',
            }}
          >
            Deduct
          </button>
        </div>

        <label style={{ display: 'block', color: '#9fb3c8', fontSize: 12, marginBottom: 6 }}>Amount (‚Çπ)</label>
        <input
          type="number"
          value={adjustAmount}
          onChange={e => setAdjustAmount(e.target.value)}
          autoFocus
          style={{
            width: '100%',
            padding: '10px 12px',
            borderRadius: 10,
            border: '1px solid #2d3f5f',
            background: '#0a1018',
            color: '#e6e9ef',
            fontSize: 14,
          }}
          placeholder="Enter amount"
        />

        <p style={{ marginTop: 10, marginBottom: 16, color: '#7c92ab', fontSize: 12 }}>
          This applies the same change to both Invested and Current values.
        </p>

        <div style={{ display: 'flex', gap: 10, justifyContent: 'flex-end' }}>
          <button
            onClick={closeAdjustModal}
            style={{ padding: '10px 14px', borderRadius: 8, border: '1px solid #2d3f5f', background: 'transparent', color: '#e6e9ef', cursor: 'pointer' }}
          >
            Cancel
          </button>
          <button
            onClick={applyAdjust}
            style={{ padding: '10px 16px', borderRadius: 8, border: 'none', background: '#22c55e', color: '#0b1910', fontWeight: 800, cursor: 'pointer' }}
          >
            Apply
          </button>
        </div>
      </Modal>
    </div>
  )
}
